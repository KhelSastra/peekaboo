var c=(n,e,t)=>new Promise((s,r)=>{var y=a=>{try{i(t.next(a))}catch(m){r(m)}},u=a=>{try{i(t.throw(a))}catch(m){r(m)}},i=a=>a.done?s(a.value):Promise.resolve(a.value).then(y,u);i((t=t.apply(n,e)).next())});import{default as h}from"https://esm.sh/cf-alert";import{default as w}from"https://esm.sh/yamljs";var g=class{constructor(e){this.queue=[],this.successCount=0,this.results={},this.parent=e,this.onload=null}handleData(e,t){if(!t.ok)throw new Error(`Loading asset ${e.name} failed.`);let s=i=>this.results[e.name]=i,r=()=>{this.successCount+=1,this.isDone()&&this.onload()},u={img:{initial:"blob",final:i=>createImageBitmap(i)},audio:{initial:"arrayBuffer",final:i=>this.parent.audioCtx.decodeAudioData(i)},txt:{initial:"text",final:i=>i},yaml:{initial:"text",final:i=>w.parse(i)}}[e.type];t[u.initial]().then(u.final).then(s).then(r)}loadAll(){if(this.onload===null)throw new Error("AssetManager: callback not set");this.numFiles=this.queue.length,this.queue.forEach((e,t)=>fetch(e.url).then(s=>{console.log(s),this.handleData(e,s),this.queue.splice(t,1)}))}queueItem(e){this.queue.includes(e)||this.queue.push(e)}queueItems(e){e.forEach(t=>this.queueItem(t))}isDone(){return this.numFiles===this.successCount}getAsset(e){return this.results[e]}};var f=class{constructor(e){this.parent=e,this.musicPlaying=!1}playMusicFile(e,t=!1){this.musicPlaying&&(this.musicPlaying=!1,this.currentSourceNode.stop());let s=this.parent.audioCtx.createBufferSource();s.buffer=this.parent.assets.getAsset(e),s.connect(this.parent.audioCtx.destination),s.loop=t,s.start(),this.currentSourceNode=s,this.musicPlaying=!0}playSFX(e){let t=this.parent.audioCtx.createBufferSource();t.buffer=this.parent.assets.getAsset(e),t.connect(this.parent.audioCtx.destination),t.loop=!1,t.start()}changeVolumeBy(e){let t=this.parent.audioCtx.createGain();this.currentSourceNode.connect(t).connect(this.parent.audioCtx.destination),t.gain.value=e}stopMusic(){this.currentSourceNode.stop()}pause(){this.parent.audioCtx.suspend().then(()=>console.log("AudioContext suspended"))}play(){this.parent.audioCtx.resume().then(()=>console.log("AudioContext resumed"))}};var b=1.2,o={x:1280,y:720};function p(){return window.innerWidth/window.innerHeight<b}function S(){return/Android|webOS|iPhone|iPad|Mac|Macintosh|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}function l(){return new URLSearchParams(window.location.search)}function v(n){return function(t){return t[n]||t.d}}var C=l(),d=v(C.get("lang")),x=class{constructor(e,t){if(this.started=!1,this.debug=!1,this.mouse={x:0,y:0,left:!1,right:!1,middle:!1},this.canvas=document.querySelector(e),this.speakerName=document.querySelector("#vn-speaker-name"),this.vnContainer=document.querySelector("#vn-controls"),this.vnText=document.querySelector("#vn-text"),this.prevBtn=document.querySelector("#vn-prev"),this.nextBtn=document.querySelector("#vn-next"),this.loadingDiv=document.querySelector("#loading"),this.vnButtons=document.querySelector("#vn-buttons"),this.audioCtx=new AudioContext,this.audio=new f(this),this.script=null,this.currentScene=null,this.currentMode="story",this.currentDialogueIndex=0,S())for(let s of[this.speakerName,this.vnContainer,this.vnText,this.vnButtons,this.canvas])s.classList.add("mobile");this.prevBtn.onclick=s=>{var r;this.currentDialogueIndex>0?this.currentDialogueIndex-=1:this.currentSceneIdx>0&&this.currentScene.dialogues&&(this.setScene(this.currentSceneIdx-1),this.currentDialogueIndex=(((r=this.currentScene.dialogues)==null?void 0:r.length)||1)-1,this.draw()),this.draw()},this.nextBtn.onclick=s=>{this.currentDialogueIndex+=1,this.currentDialogueIndex>=this.currentScene.dialogues.length?this.script.scenes.length>this.currentSceneIdx?(this.setScene(this.currentSceneIdx+1),this.draw()):this.gameOver():this.draw()},this.ctx=this.canvas.getContext("2d"),this.canvas.width=o.x,this.canvas.height=o.y,this.onWindowResize(null),this.canvas.onmousemove=s=>{this.onMouseMove(s)},this.canvas.onmousedown=s=>{this.onMouseDown(s)},this.canvas.onmouseup=s=>{this.onMouseUp(s)},window.addEventListener("resize",s=>{this.onWindowResize(s)}),this.assets=new g(this),this.assets.queueItems(t),this.assets.onload=()=>{this.onload()},this.assets.loadAll()}onload(){this.debug&&console.log("Finished loading assets."),this.begin()}onMouseMove(e){let t=this.canvas.getBoundingClientRect();this.mouse.x=Math.round((e.clientX-t.left)/this.actualSize.x*o.x),this.mouse.y=Math.round((e.clientY-t.top)/this.actualSize.y*o.y)}begin(){this.started=!0,this.script=this.assets.getAsset("script"),this.setScene(0),this.loadingDiv.style.display="none",this.draw()}setScene(e){this.currentSceneIdx=e;let t=this.script.scenes[e];if(!t){this.gameOver();return}this.currentScene=t,this.currentMode=t.mode,this.currentDialogueIndex=0,this.foundImages=0}drawScene(e){this.setScene(e),this.draw()}draw(){var t;if(!this.started)return;this.ctx.clearRect(0,0,o.x,o.y),this.currentScene.bg&&this.drawBg(this.currentScene.bg);let e=document.querySelector("#game");switch(this.currentMode){case"story":{e.style.justifyContent="initial",this.canvas.style.cursor="default",this.vnContainer.style.display="flex",(t=this.currentScene.sprites)==null||t.forEach(s=>this.drawSprite(s)),this.setCurrentDialogue(this.currentScene.dialogues[this.currentDialogueIndex]);break}case"find":{this.vnContainer.style.display="none",e.style.justifyContent="center",this.canvas.style.cursor="pointer";break}default:throw new Error("Unknown scene mode.")}}setCurrentDialogue(e){!e||(this.speakerName.innerHTML=d(e.speaker),this.vnText.innerHTML=d(e.text))}setBgGradient(e,t){let s=this.ctx.createLinearGradient(0,0,o.x,o.y);s.addColorStop(0,e),s.addColorStop(1,t),this.ctx.fillStyle=s,this.ctx.fillRect(0,0,o.x,o.y)}drawSprite(e){let t=this.assets.getAsset(e.name);t?this.ctx.drawImage(t,e.position.x,e.position.y):setTimeout(()=>this.draw(),100)}drawBg(e){let t=this.assets.getAsset(e);t?this.ctx.drawImage(t,0,0,t.width,t.height,0,0,this.canvas.width,this.canvas.height):setTimeout(()=>this.draw(),100)}onWindowResize(e){let t=.8*document.body.clientHeight,s=16/9*t,r=5;for(;s>document.body.clientWidth*.95;)s-=r,t-=.5625*r;this.actualSize={x:s,y:t},this.canvas.style.width=s+"px",this.canvas.style.height=t+"px"}onMouseDown(e){e.preventDefault(),e.button==0&&(this.mouse.left=!0),e.button==1&&(this.mouse.middle=!0),e.button==2&&(this.mouse.right=!0)}onMouseUp(e){if(e.preventDefault(),e.button==0&&(this.mouse.left=!1),e.button==1&&(this.mouse.middle=!1),e.button==2&&(this.mouse.right=!1),this.currentMode==="find"){let t=this.mouse;this.currentScene.rings.some(r=>A(r,t))&&(this.script.scenes.length>this.currentSceneIdx+1?(this.setScene(this.currentSceneIdx+1),this.draw()):this.gameOver())}}logMousePos(){this.isLoggingMousePos?window.onmousemove=null:window.onmousemove=()=>{console.log(this.mouse)}}gameOver(){return c(this,null,function*(){yield h.message(d(this.script.gameover.text),d(this.script.gameover.heading))})}};function I(n,e){return Math.sqrt(Math.pow(n.x-e.x,2)+Math.pow(n.y-e.y,2))}function A(n,e){return I(n.center,e)<n.radius}window.onload=M;function M(){let n=l();(!n.get("lang")||!n.get("script"))&&(window.location.href=window.location.href.replace("game.html","index.html")),fetch(`assets/txt/${n.get("script")}`).then(e=>{if(!e.ok)throw new Error(`Could not load asset list: "${e.statusText}".`);return e}).then(e=>e.json()).then(e=>{let t=new x("#game-canvas",e);if(p()){window.addEventListener("resize",()=>{!p()&&!t.started&&M()});return}let s=window;s.game=t,s.debug=()=>{s.game.debug=!s.game.debug}}).catch(e=>c(this,null,function*(){yield h.message(`Error: ${e} Try reloading the page.`)}))}
